name: Release Check

on:
  pull_request:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check all 3 version fields match
        run: |
          V1=$(jq -r '.version' .claude-plugin/plugin.json)
          V2=$(jq -r '.version' .claude-plugin/marketplace.json)
          V3=$(jq -r '.plugins[0].version' .claude-plugin/marketplace.json)

          echo "Checking version consistency..."
          echo "  plugin.json:                  $V1"
          echo "  marketplace.json (top):       $V2"
          echo "  marketplace.json (plugins[0]): $V3"

          if [[ "$V1" != "$V2" ]] || [[ "$V1" != "$V3" ]]; then
            echo ""
            echo "::error::Version mismatch detected!"
            echo "All 3 version fields must match."
            echo "Run: ./scripts/bump-version.sh $V1"
            exit 1
          fi
          echo ""
          echo "✓ All versions match: $V1"

      - name: Check CHANGELOG entry exists
        run: |
          VERSION=$(jq -r '.version' .claude-plugin/plugin.json)
          if ! grep -q "## \[$VERSION\]" CHANGELOG.md; then
            echo "::error::No CHANGELOG entry for v$VERSION"
            echo "Add an entry to CHANGELOG.md with header: ## [$VERSION]"
            exit 1
          fi
          echo "✓ CHANGELOG entry found for v$VERSION"

      - name: Check plugin.json has no component path declarations
        run: |
          echo "Checking plugin.json does not declare component paths..."
          echo "(Claude Code auto-discovers skills/, agents/, hooks/ from standard directories)"
          for field in skills agents hooks commands; do
            VALUE=$(jq -r ".$field // empty" .claude-plugin/plugin.json)
            if [ -n "$VALUE" ]; then
              echo "::error::plugin.json must NOT declare '$field' (causes validation failure)"
              echo "Remove '$field' from plugin.json. Claude Code auto-discovers from standard directories."
              exit 1
            fi
            echo "  ✓ $field: not declared (correct)"
          done
          echo ""
          echo "✓ No component paths declared (auto-discovery will work)"

      - name: Check CLAUDE.md size
        run: |
          MAX_LINES=150
          LINES=$(wc -l < CLAUDE.md | tr -d ' ')
          echo "CLAUDE.md: $LINES lines (cap: $MAX_LINES)"
          if [ "$LINES" -gt "$MAX_LINES" ]; then
            echo "::error::CLAUDE.md exceeds $MAX_LINES line cap ($LINES lines)"
            echo "CLAUDE.md loads every session. Keep it concise."
            exit 1
          fi
          echo "✓ CLAUDE.md under $MAX_LINES line cap"

      - name: Check skill description character budget
        run: |
          bash scripts/validate-skills.sh

      - name: Check hook stdout cap
        run: |
          MAX_CHARS=1200
          export CLAUDE_PROJECT_DIR="$(mktemp -d)"
          export CLAUDE_PLUGIN_ROOT="$(pwd)"

          # Create minimal initialized project
          mkdir -p "$CLAUDE_PROJECT_DIR/jaan-to/config"
          mkdir -p "$CLAUDE_PROJECT_DIR/jaan-to/context"
          mkdir -p "$CLAUDE_PROJECT_DIR/jaan-to/templates"
          mkdir -p "$CLAUDE_PROJECT_DIR/jaan-to/outputs"
          mkdir -p "$CLAUDE_PROJECT_DIR/jaan-to/learn"
          mkdir -p "$CLAUDE_PROJECT_DIR/jaan-to/docs"
          cp scripts/seeds/settings.yaml "$CLAUDE_PROJECT_DIR/jaan-to/config/" 2>/dev/null || true
          cp scripts/seeds/*.md "$CLAUDE_PROJECT_DIR/jaan-to/context/" 2>/dev/null || true

          OUTPUT=$(bash scripts/bootstrap.sh 2>/dev/null)
          SIZE=${#OUTPUT}

          echo "bootstrap.sh stdout: $SIZE chars (cap: $MAX_CHARS)"
          rm -rf "$CLAUDE_PROJECT_DIR"

          if [ "$SIZE" -gt "$MAX_CHARS" ]; then
            echo "::error::Hook stdout exceeds ${MAX_CHARS} char cap ($SIZE chars)"
            exit 1
          fi
          echo "✓ Hook stdout within ${MAX_CHARS} char cap"

      - name: Security standards validation
        run: |
          bash scripts/validate-security.sh

      - name: Validate multi-runtime distributions
        run: |
          bash scripts/validate-multi-runtime.sh

      - name: Agent Skills standard compliance
        run: |
          ERRORS=0
          # license field
          for skill in skills/*/SKILL.md; do
            if ! grep -q '^license:' "$skill"; then
              echo "::error::Missing 'license:' in $(basename $(dirname $skill))"
              ERRORS=$((ERRORS+1))
            fi
          done
          # compatibility field
          for skill in skills/*/SKILL.md; do
            if ! grep -q '^compatibility:' "$skill"; then
              echo "::error::Missing 'compatibility:' in $(basename $(dirname $skill))"
              ERRORS=$((ERRORS+1))
            fi
          done
          # "Use when" trigger phrases
          for skill in skills/*/SKILL.md; do
            desc=$(awk '/^---$/{n++; next} n==1 && /^description:/{sub(/^description: */, ""); print; exit}' "$skill")
            if ! echo "$desc" | grep -qi "Use when\|Use to\|Use for"; then
              echo "::error::Description missing trigger phrase in $(basename $(dirname $skill))"
              ERRORS=$((ERRORS+1))
            fi
          done
          # marketplace.json skills[] sync
          SKILLS_COUNT=$(jq '.plugins[0].skills | length' .claude-plugin/marketplace.json 2>/dev/null || echo 0)
          ACTUAL_COUNT=$(ls -d skills/*/SKILL.md 2>/dev/null | wc -l | tr -d ' ')
          if [ "$SKILLS_COUNT" -ne "$ACTUAL_COUNT" ]; then
            echo "::error::marketplace.json skills[] ($SKILLS_COUNT) != actual ($ACTUAL_COUNT)"
            ERRORS=$((ERRORS+1))
          fi
          [ $ERRORS -eq 0 ] && echo "✓ Agent Skills compliance passed" || exit 1

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: website/docs/package-lock.json
      - name: Build docs site
        run: cd website/docs && npm ci && npm run build

      - name: Summary
        run: |
          VERSION=$(jq -r '.version' .claude-plugin/plugin.json)
          echo ""
          echo "═══════════════════════════════════════"
          echo "  Release Check Passed: v$VERSION"
          echo "═══════════════════════════════════════"
          echo ""
          echo "All checks passed: versions, changelog,"
          echo "security standards, and docs build."
          echo "Ready to merge to main and tag."
