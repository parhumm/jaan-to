# Vulnerability Patterns — WordPress Plugin PR Review

> Reference file for wp-pr-review skill. Loaded on demand during Step 3.

---

## Grep Patterns for Deterministic Scanning

Run these against changed PHP files ONLY (not the entire codebase).

### CRITICAL — Security Patterns

```bash
# Superglobal access (check if sanitized nearby)
grep -rn '\$_GET\|\$_POST\|\$_REQUEST\|\$_SERVER\|\$_COOKIE' --include="*.php" {files}

# Database queries without prepare() (CRITICAL if user input involved)
grep -rn '\$wpdb->query\|\$wpdb->get_results\|\$wpdb->get_var\|\$wpdb->get_row\|\$wpdb->get_col' --include="*.php" {files}

# Dangerous functions
grep -rn 'unserialize\|maybe_unserialize' --include="*.php" {files}
grep -rn 'eval(\|assert(\|create_function\|extract(' --include="*.php" {files}
grep -rn 'shell_exec\|exec(\|system(\|passthru\|popen' --include="*.php" {files}

# REST routes — check for missing or permissive permission_callback
grep -rn 'register_rest_route' --include="*.php" {files}
grep -rn 'permission_callback.*__return_true' --include="*.php" {files}

# AJAX handlers — check for nonce and capability
grep -rn 'wp_ajax_' --include="*.php" {files}

# Output without escaping (check context: HTML, attribute, URL)
grep -rn 'echo\|print ' --include="*.php" {files}

# is_admin() used as authorization (CRITICAL misuse)
grep -rn 'is_admin()' --include="*.php" {files}

# Direct header redirects (open redirect risk)
grep -rn 'header(' --include="*.php" {files}
```

### WARNING — Performance Patterns

```bash
# Unbounded queries
grep -rn "posts_per_page.*-1\|nopaging.*true" --include="*.php" {files}

# Hardcoded table prefix
grep -rn "wp_options\|wp_posts\|wp_users\|wp_postmeta\|wp_terms" --include="*.php" {files}
```

### WARNING — Standards Patterns

```bash
# PHP redirect instead of WP function
grep -rn 'wp_redirect\b' --include="*.php" {files}

# PHP json instead of WP function
grep -rn 'json_encode\b' --include="*.php" {files}

# Remote file access via PHP
grep -rn 'file_get_contents\|curl_init\|curl_exec' --include="*.php" {files}

# Short PHP tags
grep -rn '<?[^p]' --include="*.php" {files}
```

---

## CVE Patterns from 2024-2025

### Authentication Bypass Pattern (CVE-2024-10924)

**Really Simple Security — 4M+ sites, CVSS 9.8**

The vulnerability: `check_login_and_get_user()` returned a `WP_REST_Response` error on failure, but the calling function never checked the return type and proceeded to authenticate anyway.

**What to look for**:
- Auth functions that return different types for success vs failure
- Callers that don't validate return type before proceeding
- Missing `is_wp_error()` checks on authentication results

```php
// VULNERABLE PATTERN
$user = check_login_and_get_user( $params );
// Missing: if ( is_wp_error( $user ) || $user instanceof WP_REST_Response ) { return; }
wp_set_auth_cookie( $user->ID );
```

### PHP Object Injection to RCE Pattern (CVE-2024-5932)

**GiveWP — 100K+ installs, CVSS 10.0**

The vulnerability: A form parameter was excluded from serialized field validation, stored as serialized data, then deserialized. A POP chain through a library's magic method led to RCE.

**What to look for**:
- `unserialize()` or `maybe_unserialize()` on any data that could originate from user input
- Serialized data stored from form submissions
- Fields excluded from validation logic

```php
// VULNERABLE PATTERN
$data = unserialize( $_GET['myvalue'] );

// ALSO VULNERABLE — data from database that was stored from user input
$stored = get_option( 'myplugin_form_data' );
$parsed = maybe_unserialize( $stored ); // If $stored came from user input
```

**Fix**: Use JSON instead of serialization for user data.

### SQL Injection via Auth Bypass Pattern (CVE-2024-27956)

**WordPress Automatic Plugin — 40K installs**

The vulnerability: An authentication check was bypassed, allowing unauthenticated SQL injection in a CSV export endpoint.

**What to look for**:
- Export/download endpoints without proper authentication
- SQL queries in AJAX or REST handlers without both nonce AND capability checks
- `$wpdb->query()` with concatenated user input

### Server-Side Template Injection Pattern (CVE-2024-6386)

**WPML — 1M+ installs, CVSS 9.9**

The vulnerability: Missing input validation on a Twig render function, exploitable by Contributor+ users.

**What to look for**:
- Template rendering functions (Twig, Blade, Smarty) with user-controlled input
- `render()`, `display()`, `compile()` calls with unvalidated parameters

### Unauthenticated RCE via REST Route (CVE-2024-25600)

**Bricks Builder — 30K installs**

The vulnerability: A REST route with no capability check allowed unauthenticated code execution. Exploited within hours of disclosure.

**What to look for**:
- REST routes with `permission_callback => '__return_true'` that execute dynamic code
- Routes that process code, templates, or expressions from request parameters

---

## Type Juggling Patterns

PHP loose comparison (`==`) causes unexpected behavior:

```php
// VULNERABLE — type juggling bypass
if ( $token == $expected_token ) { } // "0e123" == "0e456" evaluates to true

// CORRECT
if ( hash_equals( $expected_token, $token ) ) { } // Timing-safe comparison
```

**Flag**: Any `==` comparison involving security tokens, passwords, nonces, or hashes. Should use `===` or `hash_equals()`.

---

## SSRF Patterns

```php
// VULNERABLE — user controls the URL
$response = wp_remote_get( $_GET['url'] );

// CORRECT — validate against allowlist
$allowed = array( 'https://api.example.com' );
$url = sanitize_url( $_GET['url'] );
if ( ! in_array( wp_parse_url( $url, PHP_URL_HOST ), $allowed_hosts, true ) ) {
    wp_die( 'Invalid URL' );
}
$response = wp_remote_get( $url );
```

---

## File Upload Validation

```php
// VULNERABLE — trusting client-provided MIME type
$type = $_FILES['upload']['type']; // Client-controlled!

// CORRECT — server-side validation
$check = wp_check_filetype_and_ext( $file['tmp_name'], $file['name'] );
if ( ! $check['ext'] || ! $check['type'] ) {
    wp_die( 'Invalid file type' );
}
```

---

## Key Statistics

From Patchstack 2025 report:
- **43% of WordPress vulnerabilities** exploitable without authentication
- **33%** remained unpatched at public disclosure
- **1,018 vulnerabilities** affected components with 100K+ installs
- **XSS** was the most common type (~50% of all WP vulns)
- Only **7 bugs** affected WordPress core itself
- **96%** of all WP vulnerabilities were in plugins
